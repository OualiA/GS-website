<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Green Science ‚Äî Topic</title>
  <link rel="icon" href="../SS.ico">
  <meta name="theme-color" content="#0a0f0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta property="og:title" content="Green Science ‚Äî Topic">
  <meta property="og:description" content="Video lessons, explanations, exercises, quizzes, and books for this topic.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="../favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Noto+Kufi+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <noscript><div style="text-align:center;padding:80px 20px;font-family:sans-serif;color:#ccc;background:#0a0f0a;min-height:100vh"><h1 style="color:#2ECC71">Green Science</h1><p>JavaScript is required to use this site.</p></div></noscript>
  <div class="bg-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>
  <div class="grain"></div>

  <nav class="nav-bar" role="navigation" aria-label="Main navigation"><div class="nav-inner">
    <a href="../index.html" class="nav-brand">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
      <span data-i18n="siteName">Green Science</span>
    </a>
    <div class="nav-right">
      <button class="theme-btn" onclick="toggleTheme()" aria-label="Toggle theme"><svg class="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><svg class="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button>
      <button class="search-btn" onclick="openSearch()" title="Search (Ctrl+K)" aria-label="Search"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
      <div class="lang-btns">
        <button class="lang-btn active" onclick="setLang('en')" aria-label="English">EN</button>
        <button class="lang-btn" onclick="setLang('fr')" aria-label="Fran√ßais">FR</button>
        <button class="lang-btn" onclick="setLang('ar')" aria-label="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">ÿπÿ±ÿ®Ÿä</button>
      </div>
    </div>
  </div></nav>

  <main class="wrap" id="main" role="main"></main>

<script src="../js/config.js"></script>

<script src="../js/i18n.js"></script>

<script src="../js/data.js"></script>

<!-- Module data files -->

<script src="../js/modules/soil.js"></script>

<script src="../js/modules/plant.js"></script>

<script src="../js/modules/climate.js"></script>

<script src="../js/modules/stat.js"></script>

<script src="../js/news.js"></script>
<!-- Engine (must be last) -->

<script src="../js/engine.js"></script>
<script>
const mod = findModule(getParam('mod'));
const sub = findSub(mod, getParam('sub'));
const topic = findTopic(sub, getParam('topic'));

if (!topic) {
  document.getElementById('main').innerHTML =
    '<div class="empty-state" style="margin-top:60px"><p>Topic not found.</p>' +
    '<a href="' + ROOT + 'index.html" style="color:var(--green-400);margin-top:12px;display:inline-block">‚Üê Back</a></div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Collapse state persistence
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY = 'gs_collapse';
let collapseState = {};

function loadCollapseState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) collapseState = JSON.parse(raw);
  } catch(e) {}
}

function saveCollapseState() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(collapseState)); } catch(e) {}
}

// Default = open (true). Only closed if user explicitly collapsed it before.
function isSectionOpen(key) {
  return collapseState[key] !== false;
}

function toggleSection(key) {
  const header = document.querySelector('[data-section="' + key + '"]');
  const body = document.getElementById('body-' + key);
  if (!header || !body) return;

  const isOpen = header.classList.contains('open');

  if (isOpen) {
    body.style.maxHeight = body.scrollHeight + 'px';
    header.classList.remove('open');
    header.setAttribute('aria-expanded', 'false');
    collapseState[key] = false;
    requestAnimationFrame(function() {
      body.style.maxHeight = '0px';
      body.style.opacity = '0';
    });
  } else {
    header.classList.add('open');
    header.setAttribute('aria-expanded', 'true');
    collapseState[key] = true;
    body.style.maxHeight = '0px';
    body.style.opacity = '1';
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        body.style.maxHeight = body.scrollHeight + 'px';
        setTimeout(function() {
          if (header.classList.contains('open')) body.style.maxHeight = 'none';
        }, 400);
      });
    });
  }
  saveCollapseState();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Explanation text tools
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var explFontStep = 0; // -2 to +3 range
var EXPL_ZOOM_INC  = 0.1; // 10% per step
try { var saved = parseInt(localStorage.getItem('gs_expl_zoom')); if (!isNaN(saved) && saved >= -2 && saved <= 3) explFontStep = saved; } catch(e) {}

function applyExplZoom() {
  var el = document.querySelector('.topic-explanation');
  if (!el || explFontStep === 0) return;
  var zoom = 1 + explFontStep * EXPL_ZOOM_INC;
  el.style.zoom = zoom;
  el.style.webkitTextSizeAdjust = (zoom * 100) + '%';
}

function explFontSize(dir) {
  var next = explFontStep + dir;
  if (next < -2 || next > 3) return;
  explFontStep = next;
  try { localStorage.setItem('gs_expl_zoom', explFontStep); } catch(e) {}
  var el = document.querySelector('.topic-explanation');
  if (!el) { showToast('‚è≥'); return; }
  var zoom = 1 + explFontStep * EXPL_ZOOM_INC;
  el.style.zoom = zoom;
  el.style.webkitTextSizeAdjust = (zoom * 100) + '%';
}

function explCopyText() {
  var el = document.querySelector('.topic-explanation');
  if (!el) return;
  var text = el.innerText || el.textContent || '';
  navigator.clipboard.writeText(text).then(function() {
    showToast(tr('explCopied'));
  }).catch(function() {
    // Fallback
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;left:-9999px';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast(tr('explCopied'));
  });
}

// Build collapsible section HTML
function colSec(key, icon, titleKey, count, contentId) {
  var open = isSectionOpen(key);
  var chevron = '<svg class="collapse-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
  return '<div class="content-section">' +
    '<div class="section-heading collapsible' + (open ? ' open' : '') + '" data-section="' + key + '" onclick="toggleSection(\'' + key + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleSection(\'' + key + '\')}" tabindex="0" role="button" aria-expanded="' + open + '" aria-controls="body-' + key + '">' +
      '<div class="section-heading-icon">' + icon + '</div>' +
      '<h2>' + tr(titleKey) + '</h2>' +
      (count > 0 ? '<span class="section-heading-count">' + count + '</span>' : '') +
      chevron +
    '</div>' +
    '<div class="collapse-body" id="body-' + key + '" role="region" style="' + (open ? 'max-height:none;opacity:1' : 'max-height:0;opacity:0') + '">' +
      '<div id="' + contentId + '"></div>' +
    '</div></div>';
}

function onLangChange() { if (topic) { var s = window.scrollY; render(); requestAnimationFrame(function(){ window.scrollTo(0, s); }); } }

function render() {
  document.title = localText(topic.title) + ' ‚Äî Green Science';
  var grad = catGradients[sub.category] || catGradients[mod.category] || catGradients.general;
  // Safety: ensure all arrays exist
  if (!topic.courseFiles) topic.courseFiles = [];
  if (!topic.books) topic.books = [];
  if (!topic.quizzes) topic.quizzes = [];
  if (!topic.exercises) topic.exercises = [];
  if (!topic.explanation) topic.explanation = '';

  var hasVideo = topic.videoId && topic.videoId.length > 0;
  var hasPlaylist = topic.playlist && topic.playlist.length > 0;
  var hasCF = topic.courseFiles && topic.courseFiles.length > 0;
  var hasBooks = topic.books && topic.books.length > 0;
  var hasQuizzes = topic.quizzes && topic.quizzes.length > 0;
  var hasEx = topic.exercises && topic.exercises.length > 0;
  var el = document.getElementById('main');

  var h = '';

  // Breadcrumb
  h += '<div class="breadcrumb">' +
    '<a href="' + ROOT + 'index.html">' + tr('backHome') + '</a>' +
    '<span class="sep">‚Ä∫</span>' +
    '<a href="module.html?id=' + mod.id + '">' + localText(mod.title) + '</a>' +
    '<span class="sep">‚Ä∫</span>' +
    '<a href="sub.html?mod=' + mod.id + '&sub=' + sub.id + '">' + localText(sub.title) + '</a>' +
    '<span class="sep">‚Ä∫</span>' +
    '<span class="current">' + localText(topic.title) + '</span></div>';

  // Hero ‚Äî bookmark data stored globally for click handler
  window._bmData = {
    id: topic.id, icon: topic.icon, title: topic.title,
    path: { en: localText(sub.title), fr: localText(sub.title), ar: localText(sub.title) },
    href: 'pages/topic.html?mod=' + mod.id + '&sub=' + sub.id + '&topic=' + topic.id,
    grad: grad
  };
  h += '<div class="page-hero">' +
    '<div class="page-icon" style="background:' + grad + '">' + topic.icon + '</div>' +
    '<div style="flex:1"><h1 class="page-title">' + localText(topic.title) + '</h1>' +
    '<p class="page-desc">' + localText(topic.description) + '</p></div>' +
    '<button class="bookmark-btn' + (isBookmarked(topic.id) ? ' active' : '') + '" id="bmBtn" data-id="' + topic.id + '" title="' + tr(isBookmarked(topic.id) ? 'bookmarkRemove' : 'bookmarkAdd') + '">' + bookmarkStarSvg(isBookmarked(topic.id)) + '</button></div>';

  // ‚îÄ‚îÄ Explanation (collapsible, loaded from file) ‚Äî with text tools ‚îÄ‚îÄ
  var hasExplanation = topic.explanation && typeof topic.explanation === 'string' && topic.explanation.length > 0;
  if (hasExplanation) {
    var exOpen = isSectionOpen('explanation');
    var chevronSvg = '<svg class="collapse-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
    h += '<div class="content-section">' +
      '<div class="section-heading collapsible' + (exOpen ? ' open' : '') + '" data-section="explanation" onclick="toggleSection(\'explanation\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleSection(\'explanation\')}" tabindex="0" role="button" aria-expanded="' + exOpen + '" aria-controls="body-explanation">' +
        '<div class="section-heading-icon">üìñ</div>' +
        '<h2>' + tr('explanationTitle') + '</h2>' +
        '<div class="expl-toolbar" onclick="event.stopPropagation()">' +
          '<button class="expl-tool-btn" onclick="explFontSize(-1)" title="' + tr('explFontSmaller') + '"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14"/></svg><span>A</span></button>' +
          '<button class="expl-tool-btn" onclick="explFontSize(1)" title="' + tr('explFontBigger') + '"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg><span>A</span></button>' +
          '<button class="expl-tool-btn expl-copy-btn" onclick="explCopyText()" title="' + tr('explCopy') + '" id="explCopyBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>' +
        '</div>' +
        chevronSvg +
      '</div>' +
      '<div class="collapse-body" id="body-explanation" role="region" style="' + (exOpen ? 'max-height:none;opacity:1' : 'max-height:0;opacity:0') + '">' +
        '<div id="explContent"></div>' +
      '</div></div>';
  }

  // ‚îÄ‚îÄ Video Course (collapsible ‚Äî always show) ‚îÄ‚îÄ
  h += colSec('video', 'üé¨', 'videoSection', 0, 'vidContent');

  // ‚îÄ‚îÄ Course Chapters (collapsible ‚Äî always show) ‚îÄ‚îÄ
  h += colSec('courses', 'üìö', 'courseSection', hasCF ? topic.courseFiles.length : 0, 'cfContent');

  // ‚îÄ‚îÄ Exercises TD & TP (collapsible ‚Äî only if has data) ‚îÄ‚îÄ
  if (hasEx) {
    h += colSec('exercises', '‚úèÔ∏è', 'exercisesSection', topic.exercises.length, 'exContent');
  }

  // ‚îÄ‚îÄ Quizzes (NOT collapsible ‚Äî only if has valid data) ‚îÄ‚îÄ
  var validQuizzes = hasQuizzes ? topic.quizzes.filter(function(q) { return q && q.title; }) : [];
  if (validQuizzes.length > 0) {
    h += '<div class="content-section">' +
      '<div class="section-heading">' +
        '<div class="section-heading-icon">üìù</div>' +
        '<h2>' + tr('quizSection') + '</h2>' +
        '<span class="section-heading-count">' + validQuizzes.length + '</span>' +
      '</div>' +
      '<div id="qContent"></div></div>';
  }

  // ‚îÄ‚îÄ Books & References (collapsible ‚Äî only if has data) ‚îÄ‚îÄ
  if (hasBooks) {
    h += colSec('books', 'üìñ', 'booksSection', topic.books.length, 'bkContent');
  }

  // Footer
  h += '<footer><div id="contactSlot"></div><div style="margin-top:16px">&copy; 2025 Green Science &mdash; <a href="https://www.youtube.com/@greenscience-9226">' + tr('footerLink') + '</a></div></footer>';

  el.innerHTML = h;
  renderContactLinks();

  // Attach bookmark button click handler (after DOM exists)
  var bmBtn = document.getElementById('bmBtn');
  if (bmBtn) {
    bmBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleBookmark(window._bmData);
    });
  }

  // ‚îÄ‚îÄ Populate: Explanation (language-aware, fetched from file) ‚îÄ‚îÄ
  //
  //    TWO formats supported:
  //    explanation: 'explanations/soil/texture'        ‚Üí NEW: tries texture.fr.html ‚Üí texture.en.html ‚Üí texture.html
  //    explanation: 'explanations/soil/texture.html'   ‚Üí OLD: loads texture.html directly (one language)
  //
  function loadExplanation() {
    if (!hasExplanation) { console.log('[Expl] skipped: no explanation path'); return; }
    var explWrap = document.getElementById('explContent');
    if (!explWrap) { console.log('[Expl] skipped: no DOM element'); return; }
    explWrap.innerHTML = '<div class="expl-loading"><span>...</span></div>';
    var base = ROOT + topic.explanation;
    console.log('[Expl] base:', base, '| lang:', currentLang);

    // If path already ends with .html ‚Üí old format, fetch directly
    if (base.slice(-5) === '.html') {
      console.log('[Expl] old format ‚Üí fetch:', base);
      fetch(base)
        .then(function(res) { console.log('[Expl]', base, '‚Üí', res.status); return res.ok ? res.text() : ''; })
        .then(function(html) { showExplanation(explWrap, html); })
        .catch(function(e) { console.error('[Expl] ERROR:', e); showExplanation(explWrap, ''); });
      return;
    }

    // New format: try lang ‚Üí en ‚Üí plain
    var langUrl = base + '.' + currentLang + '.html';
    var enUrl = base + '.en.html';
    var plainUrl = base + '.html';
    console.log('[Expl] try:', langUrl);

    fetch(langUrl)
      .then(function(res) {
        console.log('[Expl]', langUrl, '‚Üí', res.status);
        if (res.ok) return res.text();
        if (currentLang !== 'en') {
          console.log('[Expl] fallback:', enUrl);
          return fetch(enUrl).then(function(r) { console.log('[Expl]', enUrl, '‚Üí', r.status); return r.ok ? r.text() : null; });
        }
        return null;
      })
      .then(function(html) {
        if (html) return html;
        console.log('[Expl] fallback:', plainUrl);
        return fetch(plainUrl).then(function(r) { console.log('[Expl]', plainUrl, '‚Üí', r.status); return r.ok ? r.text() : ''; });
      })
      .then(function(html) { console.log('[Expl] loaded:', html ? html.length + ' chars' : 'EMPTY'); showExplanation(explWrap, html); })
      .catch(function(e) { console.error('[Expl] ERROR:', e); showExplanation(explWrap, ''); });
  }

  function showExplanation(wrap, html) {
    var scrollBefore = window.scrollY;
    if (html) {
      wrap.innerHTML = '<div class="topic-explanation" style="opacity:0;transition:opacity .3s">' + html + '</div>';
      var el = wrap.querySelector('.topic-explanation');
      buildExplToc(el);
      applyExplZoom();
      // Restore scroll then fade in (prevents layout shift from moving user)
      requestAnimationFrame(function() {
        window.scrollTo(0, scrollBefore);
        el.style.opacity = '1';
      });
    } else {
      wrap.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"/></svg><p>' + tr('noContent') + '</p></div>';
    }
  }
  loadExplanation();

  // ‚îÄ‚îÄ Populate: Video ‚îÄ‚îÄ
  var vidWrap = document.getElementById('vidContent');
  var vidHtml = '';
  if (hasVideo) {
    vidHtml += '<div class="video-wrap"><div class="video-frame">' +
      '<iframe src="https://www.youtube-nocookie.com/embed/' + topic.videoId + '?rel=0&modestbranding=1" ' +
      'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
      'allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe></div></div>';
  } else {
    vidHtml += '<div class="video-wrap"><div class="video-placeholder">' +
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>' +
      '<span>' + tr('videoSoon') + '</span></div></div>';
  }
  if (hasPlaylist) {
    vidHtml += '<a href="' + topic.playlist + '" target="_blank" rel="noopener" class="playlist-link">' +
      ytSvg + ' ' + tr('watchPlaylist') + '</a>';
  }
  vidWrap.innerHTML = vidHtml;

  // ‚îÄ‚îÄ Populate: Course files ‚îÄ‚îÄ
  var cfWrap = document.getElementById('cfContent');
  if (hasCF) {
    var cfList = document.createElement('div'); cfList.className = 'row-list';
    topic.courseFiles.forEach(function(cf) {
      var r = document.createElement('div'); r.className = 'row-item';
      r.innerHTML = '<div class="row-icon">' + (cf.icon || 'üìÑ') + '</div>' +
        '<div class="row-info"><div class="row-title">' + localText(cf.title) + '</div></div>' +
        '<a href="' + cf.file + '" download class="row-dl">' + dlSvg + ' ' + tr('download') + '</a>';
      cfList.appendChild(r);
    });
    cfWrap.appendChild(cfList);
  } else {
    cfWrap.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg><p>' + tr('noContent') + '</p></div>';
  }

  // ‚îÄ‚îÄ Populate: Exercises (TD & TP) ‚Äî only if section exists ‚îÄ‚îÄ
  if (hasEx) {
    var exWrap = document.getElementById('exContent');
    var exList = document.createElement('div'); exList.className = 'row-list';
    topic.exercises.forEach(function(ex, i) {
      var r = document.createElement('div'); r.className = 'row-item';
      r.style.flexWrap = 'wrap';
      var badge = '<span class="ex-type-badge ' + (ex.type || 'td') + '">' + tr(ex.type === 'tp' ? 'tpLabel' : ex.type === 'other' ? 'otherLabel' : 'tdLabel') + '</span>';
      var vidBtn = (ex.videoId) ? '<button class="ex-video-toggle" onclick="toggleExVideo(\'topic-ex-' + i + '\',\'' + ex.videoId + '\', this, event)">' + ytSvg + '</button>' : '';
      r.innerHTML = '<div class="row-icon">' + (ex.icon || (ex.type === 'tp' ? 'üî¨' : ex.type === 'other' ? 'üìã' : '‚úèÔ∏è')) + '</div>' +
        '<div class="row-info"><div class="row-title">' + localText(ex.title) + '</div></div>' +
        badge + vidBtn +
        '<a href="' + ex.file + '" download class="row-dl">' + dlSvg + ' ' + tr('download') + '</a>' +
        '<div id="topic-ex-' + i + '" class="ex-video-slot" style="width:100%;display:none"></div>';
      exList.appendChild(r);
    });
    exWrap.appendChild(exList);
  }

  // ‚îÄ‚îÄ Populate: Quizzes ‚Äî only if section exists ‚îÄ‚îÄ
  if (validQuizzes.length > 0) {
    var qWrap = document.getElementById('qContent');
    var qList = document.createElement('div'); qList.className = 'row-list';
    validQuizzes.forEach(function(q) {
      var r = document.createElement('div'); r.className = 'row-item';
      var langs = q.langs ? q.langs.join(' ¬∑ ') : '';
      r.innerHTML = '<div class="row-icon">' + (q.icon || 'üìù') + '</div>' +
        '<div class="row-info">' +
          '<div class="row-title">' + localText(q.title) + '</div>' +
          '<div class="row-meta">' +
            (q.questions ? '<span class="row-meta-tag">' + q.questions + ' ' + tr('questions') + '</span><span class="row-meta-tag">¬∑</span>' : '') +
            (q.chapters ? '<span class="row-meta-tag">' + q.chapters + ' ' + tr('chapters') + '</span><span class="row-meta-tag">¬∑</span>' : '') +
            (langs ? '<span class="row-meta-tag">' + langs + '</span>' : '') +
          '</div></div>' +
        (q.file ? '<a href="' + q.file + '" download class="row-dl">' + dlSvg + ' ' + tr('download') + '</a>' : '');
      qList.appendChild(r);
    });
    qWrap.appendChild(qList);
  }

  // ‚îÄ‚îÄ Populate: Books ‚Äî only if section exists ‚îÄ‚îÄ
  if (hasBooks) {
    var bkWrap = document.getElementById('bkContent');
    var bkGrid = document.createElement('div'); bkGrid.className = 'book-grid';
    var bkToShow = topic.books.length > BOOKS_INLINE_LIMIT ? topic.books.slice(0, BOOKS_INLINE_LIMIT) : topic.books;
    bkToShow.forEach(function(bk) {
      var card = document.createElement('div'); card.className = 'book-card';
      var coverHtml = bk.cover
        ? '<img class="book-cover" src="' + ROOT + bk.cover + '" alt="' + localText(bk.title) + '" loading="lazy" onerror="coverFallback(this)">'
        : '<div class="book-cover book-cover-placeholder">' + (bk.icon || 'üìï') + '</div>';
      var auth = bk.author ? '<div class="book-author">' + tr('bookBy') + ' ' + localText(bk.author) + '</div>' : '';
      card.innerHTML = coverHtml +
        '<div class="book-card-info">' +
          '<div class="book-card-title">' + localText(bk.title) + '</div>' +
          auth +
        '</div>' +
        '<a href="' + bk.file + '" download class="book-card-dl">' + dlSvg + ' ' + tr('download') + '</a>';
      bkGrid.appendChild(card);
    });
    bkWrap.appendChild(bkGrid);
    if (topic.books.length > BOOKS_INLINE_LIMIT) {
      bkWrap.insertAdjacentHTML('beforeend', '<div class="books-view-all"><a href="books.html">' + tr('booksViewAll') + ' (' + topic.books.length + ')</a></div>');
    }
  }
}

// Init
if (topic) {
  loadCollapseState();
  setLang(initLang());
  // Track this visit for "Recently Visited" on home page
  trackVisit({
    id: topic.id,
    icon: topic.icon,
    title: topic.title,
    path: { en: localText(sub.title), fr: localText(sub.title), ar: localText(sub.title) },
    href: 'pages/topic.html?mod=' + mod.id + '&sub=' + sub.id + '&topic=' + topic.id,
    grad: catGradients[sub.category] || catGradients[mod.category] || catGradients.general,
  });
  // Mark topic as visited for progress tracking
  markTopicVisited(mod.id, sub.id, topic.id);
  // Reading progress bar
  initReadingProgress();
}
</script>
</body>
</html>
